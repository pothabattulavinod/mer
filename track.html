<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Update Orders on GitHub</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; padding: 2em; }
    .container { background: white; padding: 2em; max-width: 600px; margin: auto; border-radius: 10px; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; }
    textarea { width: 100%; height: 200px; }
  </style>
</head>
<body>
<div class="container">
  <h2>üìù Add Order to GitHub (orders.json)</h2>
  <input id="orderId" placeholder="Order ID" />
  <input id="amount" placeholder="Amount" />
  <input id="name" placeholder="Customer Name" />
  <input id="mobile" placeholder="Mobile Number" />
  <input id="date" type="date" />
  <input id="ref" placeholder="Reference" />
  <input id="token" placeholder="GitHub Token (keep private)" />
  <button onclick="addOrder()">Add Order & Update GitHub</button>
  <p id="status"></p>
  <textarea id="jsonPreview" readonly></textarea>
</div>

<script>
  const owner = "pothabattulavinod";
  const repo = "mer";
  const path = "orders.json";

  async function addOrder() {
    const status = document.getElementById("status");
    status.textContent = "üîÑ Loading existing orders...";

    const token = document.getElementById("token").value;
    const headers = {
      "Authorization": `token ${token}`,
      "Accept": "application/vnd.github.v3+json"
    };

    // Step 1: Get existing orders.json
    const fileResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      headers
    });
    const fileData = await fileResp.json();
    const sha = fileData.sha;
    const content = atob(fileData.content); // decode base64
    let orders = [];
    try {
      orders = JSON.parse(content);
    } catch (e) {
      return status.textContent = "‚ùå Error parsing existing JSON.";
    }

    // Step 2: Add new order
    const newOrder = {
      orderId: document.getElementById("orderId").value,
      amount: document.getElementById("amount").value,
      name: document.getElementById("name").value,
      mobile: document.getElementById("mobile").value,
      date: document.getElementById("date").value,
      ref: document.getElementById("ref").value
    };
    orders.push(newOrder);

    const updatedContent = btoa(JSON.stringify(orders, null, 2)); // encode to base64
    document.getElementById("jsonPreview").value = JSON.stringify(orders, null, 2);

    // Step 3: PUT to GitHub
    status.textContent = "üì§ Updating GitHub file...";
    const updateResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: "PUT",
      headers,
      body: JSON.stringify({
        message: `Add order ${newOrder.orderId}`,
        content: updatedContent,
        sha: sha
      })
    });

    if (updateResp.ok) {
      status.textContent = "‚úÖ orders.json updated on GitHub.";
    } else {
      status.textContent = "‚ùå Failed to update GitHub file.";
    }
  }
</script>
</body>
</html>
